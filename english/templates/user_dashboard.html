<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Health Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    {% include 'navigation.html' %}

    <div class="container mt-4">
        <h2 class="mb-4">Welcome, {{ user_name }}!</h2>

        <div class="row">
            <!-- Recent Readings Column -->
            <div class="col-lg-6 mb-4">
                <!-- ðŸ©º HEALTH ASSISTANT CHATBOT BLOCK -->
                <div class="card mb-4 border-0 shadow"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-center text-white py-4">
                        <i class="fa-solid fa-stethoscope fa-3x mb-3" style="animation: pulse 2s infinite;"></i>
                        <h4 class="fw-bold mb-2">Health Assistant</h4>
                        <p class="mb-3 opacity-75">Chat with our AI health assistant for symptoms, remedies & tips</p>
                        <a href="{{ url_for('patient_chat') }}" class="btn btn-light btn-lg rounded-pill px-5">
                            <i class="fa-solid fa-comments"></i> Start Chat
                        </a>
                        <div class="mt-2">
                            <small class="opacity-75">Available in English & à¤¹à¤¿à¤‚à¤¦à¥€</small>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes pulse {

                        0%,
                        100% {
                            transform: scale(1);
                            opacity: 1;
                        }

                        50% {
                            transform: scale(1.1);
                            opacity: 0.8;
                        }
                    }
                </style>

                <!-- TELECONSULTATION BLOCK -->
                <div class="card mb-4 border-primary shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fa-solid fa-video"></i> Tele-Consultation</h5>
                        <span class="badge bg-light text-primary">Live</span>
                    </div>
                    <div class="card-body text-center">
                        <p class="mb-3">Connect with your doctor instantly for follow-ups.</p>
                        <a href="{{ url_for('video_call_route', room_id=room_id) }}"
                            class="btn btn-primary btn-lg w-100 rounded-pill">
                            <i class="fa-solid fa-headset"></i> Join Video Consultation
                        </a>
                        <small class="text-muted d-block mt-2">Room ID: {{ room_id }}</small>
                    </div>
                </div>

                <!-- PRESCRIPTIONS BLOCK -->
                <div class="card mb-4 h-100">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fa-solid fa-prescription-bottle"></i> My Prescriptions</h4>
                    </div>
                    <div class="card-body">
                        {% if prescriptions %}
                        <div class="list-group">
                            {% for rx in prescriptions %}
                            <div class="list-group-item list-group-item-action flex-column align-items-start">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1 text-success">{{ rx.medication }}</h5>
                                    <small>{{ rx.timestamp }}</small>
                                </div>
                                <p class="mb-1">Dosage: {{ rx.dosage }}</p>
                                <div class="mt-2">
                                    {% if rx.status == 'Dispensed' %}
                                    <span class="badge bg-success">Dispensed</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Pending at Pharmacy</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-center text-muted">No active prescriptions.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4>My Recent Readings</h4>
                    </div>
                    <div class="card-body">
                        {% if readings %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Type</th>
                                    <th>Reading</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reading in readings %}
                                <tr>
                                    <td>{{ reading.formatted_time }}</td>
                                    <td>{{ reading.reading_type }}</td>
                                    <td>
                                        {% if reading.reading_type == 'BP' %}
                                        {{ reading.value1 }} / {{ reading.value2 }}
                                        {% else %}
                                        {{ reading.value1 }} mg/dL
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-center">You have not submitted any readings yet. Send an SMS to see your history
                            here.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Chart Column -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4>My 7-Day Blood Pressure Trend</h4>
                    </div>
                    <div class="card-body">
                        {% if chart_labels %}
                        <canvas id="bpChart"></canvas>
                        {% else %}
                        <p class="text-center">No blood pressure data available to display a chart.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Only run the chart script if there is data
        {% if chart_labels %}
        const ctx = document.getElementById('bpChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels | tojson }},
            datasets: [{
                label: 'Systolic (Top)',
                data: {{ systolic_data | tojson }},
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            tension: 0.1
                    }, {
                label: 'Diastolic (Bottom)',
                data: {{ diastolic_data | tojson }},
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            tension: 0.1
                    }]
                },
            options: {
            responsive: true,
            maintainAspectRatio: false
        }
            });
        {% endif %}
    </script>

</body>

</html>