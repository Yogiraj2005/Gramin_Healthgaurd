<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pharmacy Inventory Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Pharmacy Inventory Management</h2>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- This main form is ONLY for updating existing stock statuses -->
        <form method="POST" action="{{ url_for('pharmacy_dashboard') }}">
            {% for pharmacy in pharmacies %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">{{ pharmacy.name }} - {{ pharmacy.location }}</h5>
                        <a href="{{ url_for('pharmacy_prescriptions', pharmacy_id=pharmacy.id) }}"
                            class="btn btn-primary btn-sm">
                            <i class="fa-solid fa-file-medical"></i> View Prescriptions
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Medication Name</th>
                                <th style="width: 200px;">Current Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_data[pharmacy.id] %}
                            <tr>
                                <td>{{ item.medication_name }}</td>
                                <td>
                                    <select class="form-select form-select-sm" name="stock_status_{{ item.id }}">
                                        <option value="In Stock" {% if item.stock_status=='In Stock' %}selected{% endif
                                            %}>In Stock</option>
                                        <option value="Low Stock" {% if item.stock_status=='Low Stock' %}selected{%
                                            endif %}>Low Stock</option>
                                        <option value="Out of Stock" {% if item.stock_status=='Out of Stock'
                                            %}selected{% endif %}>Out of Stock</option>
                                    </select>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">No inventory items found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-light">
                    <!-- This button now triggers the modal popup -->
                    <button type="button" class="btn btn-outline-primary btn-sm add-medicine-btn" data-bs-toggle="modal"
                        data-bs-target="#addMedicineModal" data-pharmacy-id="{{ pharmacy.id }}"
                        data-pharmacy-name="{{ pharmacy.name }}">
                        + Add New Medicine
                    </button>
                </div>
            </div>
            {% endfor %}

            <div class="d-grid mt-3">
                <button type="submit" class="btn btn-primary btn-lg">Update All Stock Statuses</button>
            </div>
        </form>
    </div>

    <!-- THE NEW MODAL POPUP for Adding Medicine -->
    <div class="modal fade" id="addMedicineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMedicineModalLabel">Add New Medicine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_new_medicine') }}" method="POST">
                        <!-- This hidden input will tell the server which pharmacy to add to -->
                        <input type="hidden" id="modal_pharmacy_id" name="pharmacy_id" value="">

                        <div class="mb-3">
                            <label for="modal_medication_name" class="form-label">Medication Name</label>
                            <input type="text" class="form-control" name="medication_name" id="modal_medication_name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="modal_stock_status" class="form-label">Stock Status</label>
                            <select class="form-select" name="stock_status" id="modal_stock_status">
                                <option value="In Stock">In Stock</option>
                                <option value="Low Stock">Low Stock</option>
                                <option value="Out of Stock">Out of Stock</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Save Medicine</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & Custom JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // This script dynamically updates the modal depending on which button was clicked
        const addMedicineModal = document.getElementById('addMedicineModal');
        addMedicineModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const pharmacyId = button.getAttribute('data-pharmacy-id');
            const pharmacyName = button.getAttribute('data-pharmacy-name');

            const modalTitle = addMedicineModal.querySelector('.modal-title');
            const pharmacyIdInput = addMedicineModal.querySelector('#modal_pharmacy_id');

            modalTitle.textContent = 'Add New Medicine to ' + pharmacyName;
            pharmacyIdInput.value = pharmacyId;
        });
    </script>
</body>

</html>